<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de Contacto</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center p-4">

  <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
    <h1 class="text-3xl font-bold text-slate-800 mb-2">Contáctanos</h1>
    <p class="text-slate-600 mb-6">Completa el formulario y nos pondremos en contacto contigo</p>

    <form id="contactForm" class="space-y-5">

      <!-- Campo Email -->
      <div>
        <label for="email" class="block text-sm font-medium text-slate-700 mb-1.5">
          Email <span class="text-red-500">*</span>
        </label>
        <input type="email" id="email" name="email"
          class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
          placeholder="tu@email.com" />
        <p id="emailError" class="text-red-500 text-sm mt-1.5 hidden"></p>
      </div>

      <!-- Campo Asunto -->
      <div>
        <label for="subject" class="block text-sm font-medium text-slate-700 mb-1.5">
          Asunto <span class="text-red-500">*</span>
        </label>
        <input type="text" id="subject" name="subject"
          class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
          placeholder="Escribe el asunto" />
        <p id="subjectError" class="text-red-500 text-sm mt-1.5 hidden"></p>
      </div>

      <!-- Campo Mensaje -->
      <div>
        <label for="message" class="block text-sm font-medium text-slate-700 mb-1.5">
          Mensaje <span class="text-red-500">*</span>
        </label>
        <textarea id="message" name="message" rows="4"
          class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none"
          placeholder="Escribe tu mensaje aquí..."></textarea>
        <p id="messageError" class="text-red-500 text-sm mt-1.5 hidden"></p>
      </div>

      <!-- Botón de Envío -->
      <button type="submit" id="submitBtn" disabled
        class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-all disabled:bg-slate-300 disabled:cursor-not-allowed disabled:hover:bg-slate-300 flex items-center justify-center gap-2">
        <span id="btnText">Enviar Mensaje</span>
        <svg id="spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
      </button>

    </form>

    <!-- Mensaje de éxito -->
    <div id="successMessage" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
      <p class="text-green-800 font-medium">¡Mensaje enviado con éxito!</p>
    </div>
  </div>

  <script>
    // Estado del formulario

    const formState = {

      email: { value: '', valid: false, touched: false },
      subject: { value: '', valid: false, touched: false },
      message: { value: '', valid: false, touched: false }

    };


    // Elementos del DOM
    const emailInput = document.getElementById('email');
    const subjectInput = document.getElementById('subject');
    const messageInput = document.getElementById('message');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('contactForm');
    const spinner = document.getElementById('spinner');
    const btnText = document.getElementById('btnText');
    const successMessage = document.getElementById('successMessage');

    // Funciones de validación
    function validateEmail(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }

    function validateLength(text, minLength) {
      return text.trim().length >= minLength;
    }

    function showError(fieldId, message) {
      const errorElement = document.getElementById(`${fieldId}Error`);
      const inputElement = document.getElementById(fieldId);

      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
      inputElement.classList.add('border-red-500');
      inputElement.classList.remove('border-slate-300');
    }

    function hideError(fieldId) {
      const errorElement = document.getElementById(`${fieldId}Error`);
      const inputElement = document.getElementById(fieldId);

      errorElement.classList.add('hidden');
      inputElement.classList.remove('border-red-500');
      inputElement.classList.add('border-slate-300');
    }

    function validateField(fieldId, value) {
      let isValid = false;
      let errorMessage = '';

      switch (fieldId) {
        case 'email':
          if (!value.trim()) {
            errorMessage = 'El email es obligatorio';
          } else if (!validateEmail(value)) {
            errorMessage = 'El email no es válido';
          } else {
            isValid = true;
          }
          break;

        case 'subject':
          if (!value.trim()) {
            errorMessage = 'El asunto es obligatorio';
          } else if (!validateLength(value, 5)) {
            errorMessage = 'El asunto debe tener al menos 5 caracteres';
          } else {
            isValid = true;
          }
          break;

        case 'message':
          if (!value.trim()) {
            errorMessage = 'El mensaje es obligatorio';
          } else if (!validateLength(value, 5)) {
            errorMessage = 'El mensaje debe tener al menos 5 caracteres';
          } else {
            isValid = true;
          }
          break;
      }

      if (isValid) {
        hideError(fieldId);
      } else if (formState[fieldId].touched) {
        showError(fieldId, errorMessage);
      }

      formState[fieldId].valid = isValid;
      formState[fieldId].value = value;

      updateSubmitButton();
      return isValid;
    }

    function updateSubmitButton() {
      const allValid = formState.email.valid &&
        formState.subject.valid &&
        formState.message.valid;

      submitBtn.disabled = !allValid;
    }

    // Event listeners para onChange (validación mientras escribe)
    emailInput.addEventListener('input', (e) => {
      validateField('email', e.target.value);
    });

    subjectInput.addEventListener('input', (e) => {
      validateField('subject', e.target.value);
    });

    messageInput.addEventListener('input', (e) => {
      validateField('message', e.target.value);
    });

    // Event listeners para onBlur (validación al salir del campo)
    emailInput.addEventListener('blur', (e) => {
      formState.email.touched = true;
      validateField('email', e.target.value);
    });

    subjectInput.addEventListener('blur', (e) => {
      formState.subject.touched = true;
      validateField('subject', e.target.value);
    });

    messageInput.addEventListener('blur', (e) => {
      formState.message.touched = true;
      validateField('message', e.target.value);
    });

    // Manejo del envío del formulario
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Marcar todos los campos como tocados
      formState.email.touched = true;
      formState.subject.touched = true;
      formState.message.touched = true;

      // Validar todos los campos
      const emailValid = validateField('email', emailInput.value);
      const subjectValid = validateField('subject', subjectInput.value);
      const messageValid = validateField('message', messageInput.value);

      if (emailValid && subjectValid && messageValid) {
        // Mostrar spinner
        spinner.classList.remove('hidden');
        btnText.textContent = 'Enviando...';
        submitBtn.disabled = true;

        try {
          const response = await fetch('/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: emailInput.value,
              subject: subjectInput.value,
              message: messageInput.value
            })
          });

          const result = await response.json();

          if (result.success) {
            // Éxito: ocultar spinner, mostrar mensaje
            spinner.classList.add('hidden');
            btnText.textContent = 'Enviar Mensaje';
            successMessage.classList.remove('hidden');

            form.reset();
            formState.email = { value: '', valid: false, touched: false };
            formState.subject = { value: '', valid: false, touched: false };
            formState.message = { value: '', valid: false, touched: false };
            updateSubmitButton();

            setTimeout(() => {
              successMessage.classList.add('hidden');
            }, 3000);
          } else {
            throw new Error('Error enviando el correo');
          }
        } catch (error) {
          spinner.classList.add('hidden');
          btnText.textContent = 'Enviar Mensaje';
          alert('No se pudo enviar el mensaje. Intenta de nuevo.');
        }
      }
    });
  </script>

</body>

</html>